<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –¢–µ—Ö–Ω–∏–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system}
    .placeholder-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    img.loaded { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root" class="p-4 max-w-md mx-auto"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); } catch(e) {}

    // ====== –ú–û–õ–ù–ò–ï–ù–û–°–ù–´–ï PLACEHOLDER'–´ ======
    const PLACEHOLDERS = {
      'iPhone': 'https://via.placeholder.com/300x300/007AFF/FFFFFF?text=iPhone&font=700',
      'iPad': 'https://via.placeholder.com/300x300/34C759/FFFFFF?text=iPad&font=700', 
      'MacBook': 'https://via.placeholder.com/300x300/FFD60A/000000?text=MacBook&font=700',
      'Apple Watch': 'https://via.placeholder.com/300x300/AF52DE/FFFFFF?text=Watch&font=700',
      'AirPods': 'https://via.placeholder.com/300x300/30D158/FFFFFF?text=AirPods&font=700'
    };

    const products = [
      {id:1, name:'iPhone 15 Pro Max', price:1400, img:'https://images.unsplash.com/photo-1691113485254-72a612c2d8ab?w=300&h=300&fit=crop', cat:'iPhone'},
      {id:2, name:'iPhone 15 Pro', price:1200, img:'https://images.unsplash.com/photo-1691113484676-7ab5010a5a4c?w=300&h=300&fit=crop', cat:'iPhone'},
      {id:3, name:'iPhone 15', price:900, img:'https://images.unsplash.com/photo-1693622503037-0a9a5f6f9b3e?w=300&h=300&fit=crop', cat:'iPhone'},
      {id:4, name:'iPad Pro', price:1300, img:'https://images.unsplash.com/photo-1583354355313-1cd0b3f6680f?w=300&h=300&fit=crop', cat:'iPad'},
      {id:5, name:'iPad Air', price:700, img:'https://images.unsplash.com/photo-1561154464-82e9adf32761?w=300&h=300&fit=crop', cat:'iPad'},
      {id:6, name:'MacBook Air', price:1300, img:'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300&h=300&fit=crop', cat:'MacBook'},
      {id:7, name:'MacBook Pro', price:2000, img:'https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=300&h=300&fit=crop', cat:'MacBook'},
      {id:8, name:'Apple Watch Ultra', price:850, img:'https://images.unsplash.com/photo-1579586140626-2882d73086ec?w=300&h=300&fit=crop', cat:'Apple Watch'},
      {id:9, name:'Apple Watch', price:450, img:'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&h=300&fit=crop', cat:'Apple Watch'},
      {id:10, name:'AirPods Pro 2', price:280, img:'https://images.unsplash.com/photo-1584822172844-3dd80ee2ed17?w=300&h=300&fit=crop', cat:'AirPods'},
      {id:11, name:'AirPods', price:150, img:'https://images.unsplash.com/photo-1610945262588-5e9e9fa7b67f?w=300&h=300&fit=crop', cat:'AirPods'}
    ];

    const CATEGORIES = ['–í—Å–µ', 'iPhone', 'iPad', 'MacBook', 'Apple Watch', 'AirPods'];
    let selectedCategory = '–í—Å–µ', query = '', randomIds = pickRandomIds(products, 8);
    const root = document.getElementById('root');

    // ====== –ö–≠–® –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ======
    const imageCache = new Map();
    function preloadImage(url, category) {
      if (imageCache.has(url)) return imageCache.get(url);
      
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          imageCache.set(url, img.src);
          resolve(img.src);
        };
        img.onerror = () => {
          // fallback –Ω–∞ placeholder
          const placeholder = PLACEHOLDERS[category] || 'https://via.placeholder.com/300x300/ddd/999?text=No+Image';
          imageCache.set(url, placeholder);
          resolve(placeholder);
        };
        img.src = url;
      });
    }

    // ====== –ú–û–õ–ù–ò–ï–ù–û–°–ù–´–ô –†–ï–ù–î–ï–† ======
    function render() {
      const list = getVisibleProducts();
      
      root.innerHTML = `
        <div class="mb-5">
          <h1 class="text-3xl font-bold text-center mb-4">üõí –ú–∞–≥–∞–∑–∏–Ω</h1>
          <div class="flex items-center gap-3">
            <div class="flex-1 bg-white rounded-2xl shadow px-3 py-2">
              <label class="text-xs text-gray-500 block mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <div class="flex items-center gap-2">
                <select id="category" class="w-full bg-transparent border-none font-semibold text-base focus:outline-none appearance-none">
                  ${CATEGORIES.map(c => `<option value="${c}" ${c===selectedCategory?'selected':''}>${c}</option>`).join('')}
                </select>
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </div>
            </div>
            <div class="w-44 bg-white rounded-2xl shadow px-3 py-2">
              <label class="text-xs text-gray-500 block mb-1">–ü–æ–∏—Å–∫</label>
              <div class="flex items-center">
                <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
                </svg>
                <input id="search" value="${escapeHtml(query)}" placeholder="–ü–æ–∏—Å–∫..." class="w-full bg-transparent outline-none text-sm" />
              </div>
            </div>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs text-gray-500">–ü–æ–∫–∞–∑–∞–Ω–æ: <span class="font-semibold">${list.length}</span></div>
            <button id="refresh" class="text-sm font-semibold px-3 py-2 rounded-xl bg-white shadow">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">${list.map(p => productCard(p)).join('')}</div>
      `;

      // handlers
      setupHandlers();
      
      // ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
      list.forEach(product => {
        const imgElement = document.querySelector(`[data-product-id="${product.id}"]`);
        if (imgElement) loadProductImage(imgElement, product);
      });
    }

    function productCard(product) {
      const placeholder = PLACEHOLDERS[product.cat] || 'https://via.placeholder.com/300x300/ddd/999?text=?';
      return `
        <div class="bg-white rounded-2xl p-4 shadow-lg hover:shadow-2xl transition-all group cursor-pointer" onclick="addToCart(${product.id})" data-product-id="${product.id}">
          <div class="w-full h-32 rounded-xl object-cover mb-3 group-hover:scale-105 transition-transform placeholder-shimmer bg-gray-200 flex items-center justify-center">
            <img src="${placeholder}" class="w-full h-32 rounded-xl object-cover opacity-0 placeholder-shimmer" data-src="${product.img}" />
          </div>
          <div class="font-bold text-base mb-1 truncate">${escapeHtml(product.name)}</div>
          <div class="text-blue-600 font-black text-xl mb-3">$${product.price}</div>
          <div class="flex justify-center">
            <div class="p-3 bg-blue-50 rounded-xl group-hover:bg-blue-100 transition-all">
              <svg class="w-7 h-7 text-blue-600 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 3.5A2 2 0 005.5 19V9a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H7.5a2 2 0 01-1.5-1zM16 17a1 1 0 11-2 0 1 1 0 012 0z"/>
              </svg>
            </div>
          </div>
        </div>
      `;
    }

    async function loadProductImage(imgElement, product) {
      const realSrc = imgElement.dataset.src;
      try {
        const cachedSrc = await preloadImage(realSrc, product.cat);
        imgElement.src = cachedSrc;
        imgElement.classList.remove('opacity-0');
        imgElement.classList.add('loaded');
        imgElement.parentElement.classList.remove('placeholder-shimmer');
      } catch(e) {
        console.log('Image load failed:', realSrc);
      }
    }

    function setupHandlers() {
      document.getElementById('category').addEventListener('change', (e) => {
        selectedCategory = e.target.value;
        if (selectedCategory === '–í—Å–µ') randomIds = pickRandomIds(products, 8);
        render();
      });

      document.getElementById('search').addEventListener('input', (e) => {
        query = e.target.value || '';
        render();
      });

      document.getElementById('refresh').addEventListener('click', () => {
        if (selectedCategory === '–í—Å–µ') randomIds = pickRandomIds(products, 8);
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        render();
      });
    }

    // –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    function getVisibleProducts() {
      let base = selectedCategory === '–í—Å–µ' ? 
        products.filter(p => randomIds.includes(p.id)) : 
        products.filter(p => p.cat === selectedCategory);
      if (query.trim()) {
        const q = query.trim().toLowerCase();
        base = base.filter(p => p.name.toLowerCase().includes(q) || p.cat.toLowerCase().includes(q));
      }
      return base;
    }

    function pickRandomIds(items, count) {
      const ids = items.map(x => x.id);
      for (let i = ids.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [ids[i], ids[j]] = [ids[j], ids[i]];
      }
      return ids.slice(0, Math.min(count, ids.length));
    }

    function escapeHtml(s) {
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
      return String(s).replace(/[&<>"']/g, m => map[m]);
    }

    function addToCart(id) {
      const product = products.find(p => p.id === id);
      tg?.HapticFeedback?.impactOccurred('medium');
      tg?.showAlert?.(`‚úÖ ${product.name}`);
    }
    window.addToCart = addToCart;

    // ‚ö° –°–†–ê–ó–£ –†–ï–ù–î–ï–†–ò–ú
    render();
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Магазин Техники</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:system-ui,-apple-system}</style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root" class="p-4 max-w-md mx-auto"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); } catch(e) {}

    // ====== ДАННЫЕ ======
    const products = [
      // iPhone
      {id:1,  name:'iPhone 15 Pro Max', price:1400, img:'https://images.unsplash.com/photo-1691113485254-72a612c2d8ab?w=300&h=300&fit=crop', cat:'iPhone'},
      {id:2,  name:'iPhone 15 Pro',     price:1200, img:'https://images.unsplash.com/photo-1691113484676-7ab5010a5a4c?w=300&h=300&fit=crop', cat:'iPhone'},
      {id:3,  name:'iPhone 15',         price:900,  img:'https://images.unsplash.com/photo-1693622503037-0a9a5f6f9b3e?w=300&h=300&fit=crop', cat:'iPhone'},

      // iPad
      {id:4,  name:'iPad Pro',          price:1300, img:'https://images.unsplash.com/photo-1583354355313-1cd0b3f6680f?w=300&h=300&fit=crop', cat:'iPad'},
      {id:5,  name:'iPad Air',          price:700,  img:'https://images.unsplash.com/photo-1561154464-82e9adf32761?w=300&h=300&fit=crop', cat:'iPad'},

      // MacBook
      {id:6,  name:'MacBook Air',       price:1300, img:'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300&h=300&fit=crop', cat:'MacBook'},
      {id:7,  name:'MacBook Pro',       price:2000, img:'https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=300&h=300&fit=crop', cat:'MacBook'},

      // Apple Watch
      {id:8,  name:'Apple Watch Ultra', price:850,  img:'https://images.unsplash.com/photo-1579586140626-2882d73086ec?w=300&h=300&fit=crop', cat:'Apple Watch'},
      {id:9,  name:'Apple Watch',       price:450,  img:'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&h=300&fit=crop', cat:'Apple Watch'},

      // AirPods
      {id:10, name:'AirPods Pro 2',     price:280,  img:'https://images.unsplash.com/photo-1584822172844-3dd80ee2ed17?w=300&h=300&fit=crop', cat:'AirPods'},
      {id:11, name:'AirPods',          price:150,  img:'https://images.unsplash.com/photo-1610945262588-5e9e9fa7b67f?w=300&h=300&fit=crop', cat:'AirPods'}
    ];

    const CATEGORIES = ['Все', 'iPhone', 'iPad', 'MacBook', 'Apple Watch', 'AirPods'];

    // ====== СОСТОЯНИЕ ======
    let selectedCategory = 'Все';
    let query = '';
    let randomIds = pickRandomIds(products, 8); // витрина по умолчанию

    const root = document.getElementById('root');

    // ====== РЕНДЕР ======
    function render() {
      const list = getVisibleProducts();

      root.innerHTML = `
        <div class="mb-5">
          <h1 class="text-3xl font-bold text-center mb-4">Магазин</h1>

          <div class="flex items-center gap-3">
            <!-- Dropdown -->
            <div class="flex-1 bg-white rounded-2xl shadow px-3 py-2">
              <label class="text-xs text-gray-500 block mb-1">Категория</label>
              <div class="flex items-center gap-2">
                <select id="category"
                        class="w-full bg-transparent border-none font-semibold text-base focus:outline-none appearance-none">
                  ${CATEGORIES.map(c => `<option value="${c}" ${c===selectedCategory?'selected':''}>${c==='Все'?'Все товары':c}</option>`).join('')}
                </select>
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </div>
            </div>

            <!-- Search справа сверху -->
            <div class="w-44 bg-white rounded-2xl shadow px-3 py-2">
              <label class="text-xs text-gray-500 block mb-1">Поиск</label>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
                </svg>
                <input id="search"
                       value="${escapeHtml(query)}"
                       placeholder="iPhone..."
                       class="w-full bg-transparent outline-none text-sm" />
              </div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs text-gray-500">
              Показано: <span class="font-semibold text-gray-700">${list.length}</span>
            </div>
            <button id="refresh"
                    class="text-sm font-semibold px-3 py-2 rounded-xl bg-white shadow active:scale-[0.99]">
              Обновить
            </button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          ${list.map(p => productCard(p)).join('')}
        </div>
      `;

      // handlers
      document.getElementById('category').addEventListener('change', (e) => {
        selectedCategory = e.target.value;
        // если вернулись в "Все" — обновим витрину рандома
        if (selectedCategory === 'Все') randomIds = pickRandomIds(products, 8);
        render();
      });

      document.getElementById('search').addEventListener('input', (e) => {
        query = e.target.value || '';
        render();
      });

      document.getElementById('refresh').addEventListener('click', () => {
        // обновление рандома независимо от поиска/категории:
        // - в "Все" обновляем витрину
        // - в категории — просто перемешаем внутри категории (визуально "рандом")
        if (selectedCategory === 'Все') {
          randomIds = pickRandomIds(products, 8);
        } else {
          // не обязательно, но приятно: меняем порядок
          // (фильтр по категории всё равно сохранится)
        }
        if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        render();
      });
    }

    // ====== ЛОГИКА ОТБОРА ======
    function getVisibleProducts() {
      let base;

      if (selectedCategory === 'Все') {
        base = products.filter(p => randomIds.includes(p.id));
      } else {
        base = products.filter(p => p.cat === selectedCategory);
      }

      if (query.trim()) {
        const q = query.trim().toLowerCase();
        base = base.filter(p =>
          p.name.toLowerCase().includes(q) ||
          p.cat.toLowerCase().includes(q)
        );
      }

      return base;
    }

    // ====== UI ======
    function productCard(product) {
      return `
        <div class="bg-white rounded-2xl p-4 shadow-lg hover:shadow-2xl transition-all group cursor-pointer"
             onclick="addToCart(${product.id})">
          <img src="${product.img}"
               class="w-full h-32 rounded-xl object-cover mb-3 group-hover:scale-105 transition-transform"
               onerror="this.src='https://via.placeholder.com/300x300/ddd/999?text=No+Image'">
          <div class="font-bold text-base mb-1 truncate">${escapeHtml(product.name)}</div>
          <div class="text-blue-600 font-black text-xl mb-3">$${product.price}</div>

          <!-- только иконка корзины -->
          <div class="flex justify-center">
            <div class="p-3 bg-blue-50 rounded-xl group-hover:bg-blue-100 transition-all">
              <svg class="w-7 h-7 text-blue-600 group-hover:scale-110 transition-transform"
                   fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 3.5A2 2 0 005.5 19V9a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H7.5a2 2 0 01-1.5-1zM16 17a1 1 0 11-2 0 1 1 0 012 0z"/>
              </svg>
            </div>
          </div>
        </div>
      `;
    }

    // ====== корзина (пока просто алерт) ======
    function addToCart(id) {
      const product = products.find(p => p.id === id);
      tg?.HapticFeedback?.impactOccurred('medium');
      tg?.showAlert?.(`✅ Добавлено: ${product.name}`);
    }
    window.addToCart = addToCart;

    // ====== helpers ======
    function pickRandomIds(items, count) {
      const ids = items.map(x => x.id);
      for (let i = ids.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [ids[i], ids[j]] = [ids[j], ids[i]];
      }
      return ids.slice(0, Math.min(count, ids.length));
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    render();
  </script>
</body>
</html>


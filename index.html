<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –¢–µ—Ö–Ω–∏–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system}
    .placeholder-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    img.loaded { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root" class="p-4 max-w-md mx-auto"></div>

  <script>
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); } catch(e) {}

    // üî• –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–® GOOGLE APPS SCRIPT URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbzkn7wvU3uDOuIu3GSWWYg5jWoyzBfHVAAAzpGeGaX7u5mvN7ZYBXbmfGoIN_7AdrbNnQ/exec';
    
    // Fallback —Ç–æ–≤–∞—Ä—ã (–µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
    const FALLBACK_PRODUCTS = [
      {id:1, name:'iPhone 15 Pro Max', price:1400, img:'https://via.placeholder.com/300x300/007AFF/FFFFFF?text=iPhone', cat:'iPhone'},
      {id:2, name:'iPad Air 11"', price:700, img:'https://via.placeholder.com/300x300/34C759/FFFFFF?text=iPad', cat:'iPad'},
      {id:3, name:'MacBook Air M3', price:1300, img:'https://via.placeholder.com/300x300/FFD60A/000000?text=MacBook', cat:'MacBook'}
    ];

    const CATEGORIES = ['–í—Å–µ', 'iPhone', 'iPad', 'MacBook', 'Apple Watch', 'AirPods'];
    let selectedCategory = '–í—Å–µ', query = '', randomIds = [], loadedCount = 10, imageCache = new Map(), productsData = null;
    const root = document.getElementById('root');
    const PLACEHOLDERS = {
      'iPhone': 'https://via.placeholder.com/300x300/007AFF/FFFFFF?text=iPhone',
      'iPad': 'https://via.placeholder.com/300x300/34C759/FFFFFF?text=iPad', 
      'MacBook': 'https://via.placeholder.com/300x300/FFD60A/000000?text=MacBook',
      'Apple Watch': 'https://via.placeholder.com/300x300/AF52DE/FFFFFF?text=Watch',
      'AirPods': 'https://via.placeholder.com/300x300/30D158/FFFFFF?text=AirPods'
    };

    // ====== –ó–ê–ì–†–£–ó–ö–ê –¢–û–í–ê–†–û–í –ò–ó GOOGLE SHEETS ======
    async function initApp() {
      try {
        root.innerHTML = `
          <div class="flex flex-col items-center justify-center min-h-[400px]">
            <div class="w-20 h-20 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin mb-4"></div>
            <div class="text-lg font-semibold text-gray-700 mb-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
            <div class="text-sm text-gray-500">–ò–∑ Google Sheets</div>
          </div>
        `;
        
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        productsData = await response.json();
        console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', productsData.length);
        
        if (selectedCategory === '–í—Å–µ') {
          randomIds = pickRandomIds(productsData, Math.min(20, productsData.length));
        }
        
      } catch(error) {
        console.error('‚ùå API –æ—à–∏–±–∫–∞:', error);
        productsData = FALLBACK_PRODUCTS;
        tg?.showAlert?.('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-—Ç–æ–≤–∞—Ä—ã');
      }
      
      render();
    }

    // ====== –û–°–ù–û–í–ù–û–ô –†–ï–ù–î–ï–† ======
    function render() {
      if (!productsData || productsData.length === 0) {
        root.innerHTML = '<div class="text-center p-20 text-gray-500">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
        return;
      }

      const list = getVisibleProducts();
      const showCount = Math.min(loadedCount, list.length);
      
      root.innerHTML = `
        <div class="mb-5">
          <h1 class="text-3xl font-bold text-center mb-4">üõí –ú–∞–≥–∞–∑–∏–Ω</h1>
          <div class="flex items-center gap-3">
            <div class="flex-1 bg-white rounded-2xl shadow px-3 py-2">
              <label class="text-xs text-gray-500 block mb-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select id="category" class="w-full bg-transparent border-none font-semibold text-base focus:outline-none appearance-none">
                ${CATEGORIES.map(c => `<option value="${c}" ${c===selectedCategory?'selected':''}>${c}</option>`).join('')}
              </select>
            </div>
            <div class="w-44 bg-white rounded-2xl shadow px-3 py-2">
              <label class="text-xs text-gray-500 block mb-1">–ü–æ–∏—Å–∫</label>
              <div class="flex items-center">
                <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
                </svg>
                <input id="search" value="${escapeHtml(query)}" placeholder="–ü–æ–∏—Å–∫..." class="w-full bg-transparent outline-none text-sm" />
              </div>
            </div>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs text-gray-500">
              –ü–æ–∫–∞–∑–∞–Ω–æ: <span class="font-semibold">${showCount}</span> –∏–∑ ${list.length}
            </div>
            <div class="text-xs text-blue-600 font-semibold">Google Sheets API</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 pb-20" id="productGrid">
          ${list.slice(0, showCount).map(p => productCard(p)).join('')}
        </div>
      `;

      setupHandlers();
      loadImages(list.slice(0, showCount));
      setTimeout(setupInfiniteScroll, 100);
    }

    // ====== –ö–ê–†–¢–û–ß–ö–ê –¢–û–í–ê–†–ê ======
    function productCard(product) {
      const placeholder = PLACEHOLDERS[product.cat] || 'https://via.placeholder.com/300x300/ddd/999?text=?';
      return `
        <div class="bg-white rounded-2xl p-4 shadow-lg hover:shadow-2xl transition-all group cursor-pointer relative" 
             onclick="addToCart(${product.id})" data-product-id="${product.id}">
          <div class="w-full h-32 rounded-xl mb-3 group-hover:scale-105 transition-transform placeholder-shimmer bg-gray-200 flex items-center justify-center relative overflow-hidden">
            <img src="${placeholder}" class="w-full h-32 rounded-xl object-cover absolute inset-0 opacity-0" 
                 data-src="${product.img}" data-product-id="${product.id}" />
          </div>
          <div class="font-bold text-base mb-1 truncate">${escapeHtml(product.name)}</div>
          <div class="text-blue-600 font-black text-xl mb-4">$${product.price}</div>
          <div class="absolute bottom-3 right-3 p-2 bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg group-hover:scale-110 transition-all">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
            </svg>
          </div>
        </div>
      `;
    }

    // ====== –ü–†–û–ß–ò–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ======
    function setupHandlers() {
      document.getElementById('category')?.addEventListener('change', (e) => {
        selectedCategory = e.target.value;
        loadedCount = 10;
        if (selectedCategory === '–í—Å–µ') randomIds = pickRandomIds(productsData || [], 20);
        render();
      });

      document.getElementById('search')?.addEventListener('input', (e) => {
        query = e.target.value || '';
        loadedCount = 10;
        render();
      });
    }

    function setupInfiniteScroll() {
      const grid = document.getElementById('productGrid');
      if (!grid) return;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const list = getVisibleProducts();
            if (loadedCount < list.length) {
              loadedCount += 10;
              render();
              tg?.HapticFeedback?.impactOccurred('light');
            }
          }
        });
      }, { threshold: 0.1 });

      const lastCard = grid.lastElementChild;
      if (lastCard) observer.observe(lastCard);
    }

    async function loadImages(products) {
      products.forEach(product => {
        const imgElement = document.querySelector(`img[data-product-id="${product.id}"]`);
        if (imgElement && !imgElement.src.includes(imgElement.dataset.src)) {
          setTimeout(() => loadProductImage(imgElement, product), 100);
        }
      });
    }

    async function loadProductImage(imgElement, product) {
      const realSrc = imgElement.dataset.src;
      if (imageCache.has(realSrc)) {
        imgElement.src = imageCache.get(realSrc);
        imgElement.classList.remove('opacity-0');
        imgElement.closest('.placeholder-shimmer')?.classList.remove('placeholder-shimmer');
        return;
      }

      try {
        const img = new Image();
        img.onload = () => {
          imageCache.set(realSrc, img.src);
          imgElement.src = img.src;
          imgElement.classList.remove('opacity-0');
          imgElement.classList.add('loaded');
          imgElement.closest('.placeholder-shimmer')?.classList.remove('placeholder-shimmer');
        };
        img.onerror = () => {
          const placeholder = PLACEHOLDERS[product.cat] || PLACEHOLDERS['iPhone'];
          imageCache.set(realSrc, placeholder);
          imgElement.src = placeholder;
          imgElement.classList.remove('opacity-0');
        };
        img.src = realSrc;
      } catch(e) {}
    }

    function getVisibleProducts() {
      if (!productsData || productsData.length === 0) return [];
      
      let base = selectedCategory === '–í—Å–µ' ? 
        productsData.filter(p => randomIds.includes(p.id)) : 
        productsData.filter(p => p.cat === selectedCategory);
      
      if (query.trim()) {
        const q = query.trim().toLowerCase();
        base = base.filter(p => 
          p.name?.toLowerCase().includes(q) || 
          p.cat?.toLowerCase().includes(q)
        );
      }
      return base;
    }

    function pickRandomIds(items, count) {
      const ids = items.map(x => x.id);
      for (let i = ids.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [ids[i], ids[j]] = [ids[j], ids[i]];
      }
      return ids.slice(0, Math.min(count, ids.length));
    }

    function escapeHtml(s) {
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
      return String(s).replace(/[&<>"']/g, m => map[m]);
    }

    function addToCart(id) {
      const product = productsData?.find(p => p.id === id) || FALLBACK_PRODUCTS.find(p => p.id === id);
      tg?.HapticFeedback?.impactOccurred('medium');
      tg?.showAlert?.(`‚úÖ ${product?.name || '–¢–æ–≤–∞—Ä'} –≤ –∫–æ—Ä–∑–∏–Ω—É!`);
      tg?.MainButton?.setText('–ö–æ—Ä–∑–∏–Ω–∞ (1)')?.show();
    }
    window.addToCart = addToCart;

    // ====== –°–¢–ê–†–¢ ======
    initApp();
  </script>
</body>
</html>
